<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Saturn System Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-50:#eff6ff; --primary-100:#dbeafe; --primary-400:#60a5fa; --primary-500:#3b82f6;
      --primary-600:#2563eb; --primary-700:#1d4ed8; --primary-900:#1e3a8a;
      --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db;
      --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563; --gray-700:#374151; --gray-800:#1f2937; --gray-900:#111827;
      --success-500:#10b981; --warning-500:#f59e0b; --danger-500:#ef4444; --teal-500:#14b8a6; --indigo-500:#6366f1;
    }
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#1f2937 0%,#111827 100%);min-height:100vh;transition:all .3s cubic-bezier(.4,0,.2,1)}
    body.light{background:linear-gradient(135deg,#f0f4f8 0%,#e2e8f0 100%)}
    .glass-card{background:rgba(255,255,255,.1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2);box-shadow:0 8px 32px rgba(0,0,0,.1),0 2px 16px rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.3);border-radius:20px;transition:all .3s cubic-bezier(.4,0,.2,1)}
    body.light .glass-card{background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.05);box-shadow:0 8px 32px rgba(0,0,0,.05),0 2px 16px rgba(0,0,0,.03),inset 0 1px 0 rgba(255,255,255,.8)}
    .glass-card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.15),0 4px 20px rgba(0,0,0,.1),inset 0 1px 0 rgba(255,255,255,.3)}
    body.light .glass-card:hover{box-shadow:0 12px 40px rgba(0,0,0,.08),0 4px 20px rgba(0,0,0,.05),inset 0 1px 0 rgba(255,255,255,.8)}
    .card-header{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(29,78,216,.1));border-bottom:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:1.5rem 2rem}
    body.light .card-header{background:linear-gradient(135deg,rgba(59,130,246,.05),rgba(29,78,216,.05));border-bottom:1px solid rgba(0,0,0,.05)}
    .btn-primary{background:linear-gradient(135deg,var(--primary-500),var(--primary-600));border:none;border-radius:12px;color:#fff;font-weight:600;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(59,130,246,.3)}
    .btn-primary:hover{background:linear-gradient(135deg,var(--primary-600),var(--primary-700));transform:translateY(-1px);box-shadow:0 6px 20px rgba(59,130,246,.4)}
    .btn-secondary{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:12px;color:#fff;font-weight:500;transition:all .3s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px)}
    body.light .btn-secondary{background:rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.1);color:var(--gray-700)}
    .btn-secondary:hover{background:rgba(255,255,255,.2);transform:translateY(-1px)}
    body.light .btn-secondary:hover{background:rgba(0,0,0,.08)}
    .btn-danger{background:linear-gradient(135deg,var(--danger-500),#dc2626);border:none;border-radius:8px;color:#fff;font-weight:500;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 2px 8px rgba(239,68,68,.3)}
    .btn-danger:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);transform:translateY(-1px);box-shadow:0 4px 12px rgba(239,68,68,.4)}
    .search-input{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:12px;color:#fff;padding:.75rem 1rem;font-weight:400;transition:all .3s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px)}
    body.light .search-input{background:rgba(0,0,0,.03);border:1px solid rgba(0,0,0,.1);color:var(--gray-700)}
    .search-input:focus{outline:none;border-color:var(--primary-500);box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .search-input::placeholder{color:rgba(255,255,255,.6)}
    body.light .search-input::placeholder{color:var(--gray-400)}
    .table-container{background:rgba(255,255,255,.05);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    body.light .table-container{background:rgba(0,0,0,.02);border:1px solid rgba(0,0,0,.05)}
    .table-header{background:rgba(0,0,0,.2);backdrop-filter:blur(10px);font-weight:600;text-transform:uppercase;letter-spacing:.05em;font-size:.75rem}
    body.light .table-header{background:rgba(0,0,0,.05)}
    .table-row{border-bottom:1px solid rgba(255,255,255,.05);transition:all .2s ease}
    body.light .table-row{border-bottom:1px solid rgba(0,0,0,.05)}
    .table-row:hover{background:rgba(255,255,255,.05)}
    body.light .table-row:hover{background:rgba(0,0,0,.02)}
    .metric-value{font-size:2.5rem;font-weight:800;line-height:1;background:linear-gradient(135deg,var(--primary-400),var(--teal-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    body.light .metric-value{background:linear-gradient(135deg,var(--primary-600),var(--teal-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .metric-label{color:rgba(255,255,255,.8);font-weight:500;font-size:.875rem}
    body.light .metric-label{color:var(--gray-600)}
    .status-indicator{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:.5rem}
    .status-good{background-color:var(--success-500)} .status-warning{background-color:var(--warning-500)} .status-critical{background-color:var(--danger-500)}
    .chart-container{position:relative;height:280px;padding:1rem}
    .loader{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:50;opacity:0;visibility:hidden;transition:all .3s ease}
    .loader.show{opacity:1;visibility:visible}
    .loader-spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,.2);border-top-color:var(--primary-500);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade-in-up{animation:fadeInUp .6s ease-out}
    .text-white{color:#fff} body.light .text-white{color:var(--gray-900)}
    .text-white-80{color:rgba(255,255,255,.8)} body.light .text-white-80{color:var(--gray-700)}
    .text-white-60{color:rgba(255,255,255,.6)} body.light .text-white-60{color:var(--gray-500)}
    @media (max-width:768px){.glass-card{border-radius:16px}.card-header{padding:1rem 1.5rem;border-radius:16px 16px 0 0}.chart-container{height:240px;padding:.75rem}.metric-value{font-size:2rem}}
  </style>
</head>
<body class="min-h-screen p-4 lg:p-6">
  <!-- Loader -->
  <div id="loader" class="loader"><div class="loader-spinner"></div></div>

  <div class="max-w-7xl mx-auto">
    <div class="text-center mb-8 fade-in-up">
      <h1 class="text-4xl lg:text-5xl font-bold text-white mb-2">Saturn System Monitor</h1>
      <p class="text-white-60 text-lg">Real-time system performance monitoring</p>
    </div>

    <div class="flex flex-wrap justify-center gap-4 mb-8 fade-in-up">
      <a href="/saturn/" class="btn-primary px-6 py-3 rounded-lg flex items-center font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Back to Update Manager
      </a>
      <button id="refresh-btn" class="btn-secondary px-6 py-3 rounded-lg flex items-center font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        Refresh Data
      </button>
      <button id="theme-toggle" class="btn-secondary p-3 rounded-lg">
        <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
      </button>
    </div>

    <!-- Overview cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
      <div class="glass-card fade-in-up"><div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">CPU Usage</h3>
          <span id="cpu-status" class="status-indicator status-good"></span>
        </div>
        <div class="metric-value" id="cpu-average">0%</div>
        <p class="metric-label mt-2" id="cpu-cores-info">Loading...</p>
      </div></div>

      <div class="glass-card fade-in-up" style="animation-delay:.1s"><div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">Memory</h3>
          <span id="memory-status" class="status-indicator status-good"></span>
        </div>
        <div class="metric-value" id="memory-percentage">0%</div>
        <p class="metric-label mt-2" id="memory-usage-info">Loading...</p>
        <p class="metric-label mt-1" id="memory-used-free">Used: 0 GB Free: 0 GB</p>
      </div></div>

      <div class="glass-card fade-in-up" style="animation-delay:.2s"><div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">Disk Space</h3>
          <span id="disk-status" class="status-indicator status-good"></span>
        </div>
        <div class="metric-value" id="disk-percentage">0%</div>
        <p class="metric-label mt-2" id="disk-usage-info">Loading...</p>
        <p class="metric-label mt-1" id="disk-used-free">Used: 0 GB Free: 0 GB</p>
      </div></div>

      <div class="glass-card fade-in-up" style="animation-delay:.3s"><div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-white">Network</h3>
          <span class="status-indicator status-good"></span>
        </div>
        <div class="text-sm">
          <div class="flex justify-between mb-2"><span class="text-white-80">↑ Sent:</span><span class="text-white font-medium" id="network-sent">0 MB/s</span></div>
          <div class="flex justify-between"><span class="text-white-80">↓ Received:</span><span class="text-white font-medium" id="network-received">0 MB/s</span></div>
        </div>
      </div></div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="glass-card fade-in-up"><div class="card-header"><h2 class="text-xl font-semibold text-white">CPU Usage (Per Core)</h2></div><div class="chart-container"><canvas id="cpuChart"></canvas></div></div>
      <div class="glass-card fade-in-up"><div class="card-header"><h2 class="text-xl font-semibold text-white">Memory Usage</h2></div><div class="chart-container"><canvas id="memoryChart"></canvas></div></div>
      <div class="glass-card fade-in-up"><div class="card-header"><h2 class="text-xl font-semibold text-white">Disk Usage</h2></div><div class="chart-container"><canvas id="diskChart"></canvas></div></div>
      <div class="glass-card fade-in-up"><div class="card-header"><h2 class="text-xl font-semibold text-white">Network Traffic</h2></div><div class="chart-container"><canvas id="networkChart"></canvas></div></div>
    </div>

    <!-- Processes -->
    <div class="glass-card fade-in-up">
      <div class="card-header"><h2 class="text-xl font-semibold text-white">Running Processes</h2></div>
      <div class="p-6">
        <input type="text" id="process-search" class="search-input w-full mb-6" placeholder="Search processes by name, user, or PID...">
        <div class="table-container">
          <div style="max-height:400px;overflow-y:auto">
            <table class="w-full">
              <thead class="table-header sticky top-0">
              <tr>
                <th class="px-6 py-4 text-left cursor-pointer select-none" onclick="sortTable(0)">PID</th>
                <th class="px-6 py-4 text-left cursor-pointer select-none" onclick="sortTable(1)">User</th>
                <th class="px-6 py-4 text-left cursor-pointer select-none" onclick="sortTable(2)">CPU %</th>
                <th class="px-6 py-4 text-left cursor-pointer select-none" onclick="sortTable(3)">Memory %</th>
                <th class="px-6 py-4 text-left cursor-pointer select-none" onclick="sortTable(4)">Command</th>
                <th class="px-6 py-4 text-left">Action</th>
              </tr>
              </thead>
              <tbody id="processBody" class="text-white-80">
              <tr><td colspan="6" class="px-6 py-8 text-center text-white-60">Loading processes...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
/* ===== Globals ===== */
let cpuChart, memoryChart, diskChart, networkChart;
let cpuData = [], memoryData = [], diskData = [], sentData = [], recvData = [], labels = [];
let lastNet = { sent: 0, recv: 0 };
let lastTime = 0;
let allProcesses = [];
let sortCol = 2, sortDir = -1;   // default sort: CPU desc
const colors = { primary:'#3b82f6', success:'#10b981', warning:'#f59e0b', danger:'#ef4444', teal:'#14b8a6', indigo:'#6366f1' };
// If you serve the monitor at /saturn/monitor.html, a relative URL hits the same origin through NGINX:
const GET_SYSTEM_DATA = './get_system_data';

/* ===== Helpers ===== */
const byId = (id) => document.getElementById(id);
function formatRate(bps) {
  if (!Number.isFinite(bps) || bps < 0) bps = 0;
  if (bps < 1024) return `${bps.toFixed(0)} B/s`;
  if (bps < 1024*1024) return `${(bps/1024).toFixed(2)} KB/s`;
  return `${(bps/1024/1024).toFixed(2)} MB/s`;
}
function updateStatusIndicator(id, pct) {
  const el = byId(id);
  if (!el) return;
  const cls = pct < 60 ? 'status-good' : pct < 80 ? 'status-warning' : 'status-critical';
  el.className = `status-indicator ${cls}`;
}

/* ===== Charts ===== */
function initCharts(numCores) {
  labels = Array(60).fill('');
  cpuData = Array.from({length:numCores}, () => Array(60).fill(0));
  memoryData = Array(60).fill(0);
  diskData   = Array(60).fill(0);
  sentData   = Array(60).fill(0);
  recvData   = Array(60).fill(0);

  const coreColors = [colors.primary, colors.success, colors.warning, colors.teal, colors.indigo, colors.danger];
  const textColor = document.body.classList.contains('light') ? '#374151' : 'rgba(255,255,255,0.9)';
  const tickColor = document.body.classList.contains('light') ? '#6b7280' : 'rgba(255,255,255,0.6)';
  const gridColor = document.body.classList.contains('light') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    animation: { duration: 0 },
    plugins: {
      legend: { labels: { color: textColor, font: { family: 'Inter', size: 12, weight: '500' } } },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleColor: '#fff', bodyColor: '#fff',
        borderColor: 'rgba(255,255,255,0.2)', borderWidth: 1,
        cornerRadius: 8, padding: 12
      }
    },
    scales: {
      x: { grid: { display: false }, ticks: { color: tickColor, font: { family: 'Inter', size: 11 } } },
      y: { beginAtZero: true, grid: { color: gridColor, borderDash: [2,4] },
           ticks: { color: tickColor, font: { family: 'Inter', size: 11 } } }
    }
  };

  cpuChart = new Chart('cpuChart', {
    type: 'line',
    data: {
      labels,
      datasets: coreColors.slice(0, numCores).map((c,i)=>({
        label:`Core ${i+1}`, data: cpuData[i], borderColor:c, backgroundColor: c+'20',
        borderWidth:2, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:4
      }))
    },
    options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 100 } } }
  });

  memoryChart = new Chart('memoryChart', {
    type:'line',
    data:{ labels, datasets:[{ label:'Memory Usage (%)', data:memoryData, borderColor:colors.primary,
                               backgroundColor: colors.primary+'20', borderWidth:3, fill:true, tension:0.4,
                               pointRadius:0, pointHoverRadius:6 }] },
    options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 100 } } }
  });

  diskChart = new Chart('diskChart', {
    type:'line',
    data:{ labels, datasets:[{ label:'Disk Usage (%)', data:diskData, borderColor:colors.success,
                               backgroundColor: colors.success+'20', borderWidth:3, fill:true, tension:0.4,
                               pointRadius:0, pointHoverRadius:6 }] },
    options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 100 } } }
  });

  networkChart = new Chart('networkChart', {
    type:'line',
    data:{ labels, datasets:[
      { label:'Sent (MB/s)',     data:sentData, borderColor:colors.warning, backgroundColor:colors.warning+'20',
        borderWidth:2, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:4 },
      { label:'Received (MB/s)', data:recvData, borderColor:colors.teal,    backgroundColor:colors.teal+'20',
        borderWidth:2, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:4 },
    ]},
    options: commonOptions
  });
}

function ensureCpuDatasets(numCores) {
  if (!cpuChart) return;
  const have = cpuChart.data.datasets.length;
  const coreColors = [colors.primary, colors.success, colors.warning, colors.teal, colors.indigo, colors.danger];
  if (have < numCores) {
    for (let i = have; i < numCores; i++) {
      cpuData[i] = cpuData[i] || Array(labels.length).fill(0);
      cpuChart.data.datasets.push({
        label:`Core ${i+1}`, data:cpuData[i],
        borderColor: coreColors[i % coreColors.length],
        backgroundColor: coreColors[i % coreColors.length] + '20',
        borderWidth:2, fill:true, tension:0.4, pointRadius:0, pointHoverRadius:4
      });
    }
  } else if (have > numCores) {
    cpuChart.data.datasets.splice(numCores);
  }
}

/* ===== Rendering ===== */
function updateCharts(snapshot) {
  const numCores = Array.isArray(snapshot.cpu) ? snapshot.cpu.length : 1;

  // labels
  labels.shift(); labels.push('');

  // CPU
  for (let i=0; i<numCores; i++) {
    cpuData[i].shift();
    cpuData[i].push(Number(snapshot.cpu[i] || 0));
    cpuChart.data.datasets[i].data = cpuData[i];
  }
  const avgCpu = numCores ? snapshot.cpu.reduce((a,b)=>a+Number(b||0),0)/numCores : 0;
  byId('cpu-average').textContent = `${avgCpu.toFixed(1)}%`;
  byId('cpu-cores-info').textContent = `${numCores} cores • Average usage`;
  updateStatusIndicator('cpu-status', avgCpu);
  cpuChart.data.labels = labels;
  cpuChart.update('none');

  // Memory
  const memPct = Number(snapshot.memory?.percent || 0);
  memoryData.shift(); memoryData.push(memPct);
  memoryChart.data.datasets[0].data = memoryData;
  byId('memory-percentage').textContent = `${memPct.toFixed(1)}%`;
  byId('memory-usage-info').textContent = `${(snapshot.memory?.used || 0).toFixed(1)} GB of ${(snapshot.memory?.total || 0).toFixed(1)} GB`;
  byId('memory-used-free').textContent = `Used: ${(snapshot.memory?.used || 0).toFixed(1)} GB  Free: ${((snapshot.memory?.total || 0) - (snapshot.memory?.used || 0)).toFixed(1)} GB`;
  updateStatusIndicator('memory-status', memPct);
  memoryChart.data.labels = labels;
  memoryChart.update('none');

  // Disk
  const diskPct = Number(snapshot.disk?.percent || 0);
  diskData.shift(); diskData.push(diskPct);
  diskChart.data.datasets[0].data = diskData;
  byId('disk-percentage').textContent = `${diskPct.toFixed(1)}%`;
  byId('disk-usage-info').textContent = `${(snapshot.disk?.used || 0).toFixed(1)} GB of ${(snapshot.disk?.total || 0).toFixed(1)} GB`;
  byId('disk-used-free').textContent = `Used: ${(snapshot.disk?.used || 0).toFixed(1)} GB  Free: ${((snapshot.disk?.total || 0) - (snapshot.disk?.used || 0)).toFixed(1)} GB`;
  updateStatusIndicator('disk-status', diskPct);
  diskChart.data.labels = labels;
  diskChart.update('none');

  // Network (prefer server-provided rates; else delta bytes)
  const now = Date.now();
  const dt = lastTime ? Math.max(0.001, (now - lastTime)/1000) : 1; // s
  lastTime = now;

  let txBps = 0, rxBps = 0;
  const net = snapshot.network || {};
  if (typeof net.tx_bps === 'number' || typeof net.rx_bps === 'number') {
    txBps = Number(net.tx_bps || 0);
    rxBps = Number(net.rx_bps || 0);
  } else if (typeof net.sent === 'number' && typeof net.recv === 'number') {
    // cumulative byte counters
    if (lastNet.sent === 0 && lastNet.recv === 0) {
      // seed on first reading so first point is 0
      lastNet = { sent: net.sent, recv: net.recv };
    }
    txBps = (net.sent - lastNet.sent) / dt;
    rxBps = (net.recv - lastNet.recv) / dt;
    lastNet = { sent: net.sent, recv: net.recv };
  }

  const sentMBs = Math.max(0, txBps / (1024*1024));
  const recvMBs = Math.max(0, rxBps / (1024*1024));
  sentData.shift(); sentData.push(sentMBs);
  recvData.shift(); recvData.push(recvMBs);
  networkChart.data.datasets[0].data = sentData;
  networkChart.data.datasets[1].data = recvData;
  byId('network-sent').textContent = formatRate(txBps);
  byId('network-received').textContent = formatRate(rxBps);
  networkChart.data.labels = labels;
  networkChart.update('none');

  // Processes (normalize >100% to per‑CPU scale)
  updateProcessTable(snapshot.processes || [], numCores);
}

/* ===== Processes ===== */
function updateProcessTable(processes, numCores) {
  allProcesses = processes.map(p => ({
    ...p,
    // ps can report 200% on 2 cores; show “per full CPU” to match the cards
    cpu_display: Math.min(100, Number(p.cpu || 0) / Math.max(1, numCores))
  }));
  filterProcesses();
}
function filterProcesses() {
  const q = byId('process-search').value.toLowerCase();
  const keys = ['pid','user','cpu','memory','command'];
  const rows = allProcesses
    .filter(p =>
      String(p.command||'').toLowerCase().includes(q) ||
      String(p.user||'').toLowerCase().includes(q) ||
      String(p.pid||'').includes(q))
    .sort((a,b)=>{
      let A = a[keys[sortCol]], B = b[keys[sortCol]];
      if (typeof A === 'number' && typeof B === 'number') return sortDir * (A - B);
      A = String(A||'').toLowerCase(); B = String(B||'').toLowerCase();
      return sortDir * (A > B ? 1 : A < B ? -1 : 0);
    });

  const tbody = byId('processBody');
  tbody.innerHTML = '';
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-white-60">No processes found</td></tr>';
    return;
  }
  for (const p of rows) {
    const tr = document.createElement('tr');
    tr.className = 'table-row';
    tr.innerHTML = `
      <td class="px-6 py-4 font-mono text-sm">${p.pid}</td>
      <td class="px-6 py-4">${p.user}</td>
      <td class="px-6 py-4 font-medium" title="${Number(p.cpu||0).toFixed(1)}% raw">${(p.cpu_display*1).toFixed(1)}%</td>
      <td class="px-6 py-4 font-medium">${Number(p.memory||0).toFixed(1)}%</td>
      <td class="px-6 py-4 font-mono text-sm max-w-xs truncate" title="${p.command}">${p.command}</td>
      <td class="px-6 py-4">
        <button class="btn-danger px-3 py-1 text-sm flex items-center" onclick="killProcess(${p.pid})">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          Kill
        </button>
      </td>`;
    tbody.appendChild(tr);
  }
}
function sortTable(col) { sortDir = (sortCol === col) ? -sortDir : -1; sortCol = col; filterProcesses(); }
async function killProcess(pid) {
  if (!confirm(`Kill process ${pid}?`)) return;
  try {
    const res = await fetch(`./kill_process/${pid}`, { method:'POST' });
    const data = await res.json();
    alert(data.message || 'OK');
  } catch (e) {
    alert(`Failed: ${e.message}`);
  } finally {
    fetchMetrics();
  }
}

/* ===== Theme ===== */
function applyThemeToCharts() {
  if (!cpuChart) return;
  const light = document.body.classList.contains('light');
  const textColor = light ? '#374151' : 'rgba(255,255,255,0.9)';
  const tickColor = light ? '#6b7280' : 'rgba(255,255,255,0.6)';
  const gridColor = light ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
  [cpuChart, memoryChart, diskChart, networkChart].forEach(ch=>{
    ch.options.plugins.legend.labels.color = textColor;
    ch.options.scales.x.ticks.color = tickColor;
    ch.options.scales.y.ticks.color = tickColor;
    ch.options.scales.y.grid.color = gridColor;
    ch.update('none');
  });
}
(function initThemeToggle(){
  const themeToggle = byId('theme-toggle');
  const themeIcon   = byId('theme-icon');
  function setIcon(light){
    themeIcon.innerHTML = light
      ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>'
      : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
  }
  // initial load
  const stored = localStorage.getItem('theme');
  const light = stored === 'light';
  document.body.classList.toggle('light', light);
  setIcon(light);

  themeToggle?.addEventListener('click', ()=>{
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    setIcon(isLight);
    applyThemeToCharts();
  });
})();

/* ===== Data fetch ===== */
async function fetchMetrics() {
  try {
    byId('loader')?.classList.add('show');
    const res = await fetch(GET_SYSTEM_DATA, { cache:'no-store', headers:{ 'Accept':'application/json' }});
    if (res.status === 401) {
      byId('processBody').innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">
        Authentication required. Reload and sign in to /saturn/, then retry.
      </td></tr>`;
      return;
    }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const cores = Array.isArray(data.cpu) && data.cpu.length ? data.cpu.length : 1;
    if (!cpuChart) {
      initCharts(cores);
      // seed network counters so first point is 0 MB/s
      if (data.network && typeof data.network.sent === 'number' && typeof data.network.recv === 'number') {
        lastNet = { sent: data.network.sent, recv: data.network.recv };
      }
      lastTime = Date.now();
    } else {
      ensureCpuDatasets(cores);
    }

    updateCharts(data);
  } catch (err) {
    console.error('fetchMetrics error:', err);
    byId('processBody').innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">
      Error loading data: ${err.message}
    </td></tr>`;
  } finally {
    byId('loader')?.classList.remove('show');
  }
}

/* ===== Wire up controls & start ===== */
byId('process-search')?.addEventListener('input', filterProcesses);
byId('refresh-btn')?.addEventListener('click', ()=>{
  // debounce simple
  clearTimeout(window.__rfTimeout); window.__rfTimeout = setTimeout(fetchMetrics, 200);
});
setInterval(fetchMetrics, 5000);
fetchMetrics();
</script>
</body>
</html>
