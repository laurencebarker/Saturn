<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Saturn Go System Monitor</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#1f2937; --fg:#ffffff; --glass:rgba(255,255,255,0.08); --line:rgba(255,255,255,0.2);
    --chart-h: 220px;
  }
  body.light{ --bg:#f3f4f6; --fg:#111827; --glass:rgba(0,0,0,0.04); --line:rgba(0,0,0,0.08) }
  body{
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(900px 600px at 0% 0%, rgba(59,130,246,.22), transparent 60%),
                radial-gradient(800px 500px at 100% 0%, rgba(16,185,129,.16), transparent 55%),
                var(--bg);
    color:var(--fg); min-height:100vh;
  }
  .glass{ background:var(--glass); border:1px solid var(--line); border-radius:16px; }

  /* Responsive chart containers that actually shrink */
  .chart-box{ position:relative; height:var(--chart-h); }
  .chart-box canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; }
  @media (max-width: 1024px){ :root{ --chart-h: 180px; } }
  @media (max-width: 768px){  :root{ --chart-h: 150px; } }
  @media (max-width: 420px){  :root{ --chart-h: 130px; } }

  /* Compact table on small screens */
  @media (max-width:640px){
    th, td { padding-left:.5rem !important; padding-right:.5rem !important; }
    #proc-search{ width:100% !important; }
  }
</style>
</head>
<body class="min-h-screen p-4 lg:p-6">
  <div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold">Saturn Go System Monitor</h1>
        <p class="opacity-80">Realtime system performance</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/saturn/" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 hover:bg-white/20">Back</a>
        <button id="theme-toggle" class="px-3 py-2 rounded-lg bg-white/10 border border-white/20" title="Toggle theme">
          <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
             d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Top stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
      <div class="glass p-4">
        <div class="text-sm opacity-80 mb-1">CPU Avg</div>
        <div id="cpu-avg" class="text-3xl font-extrabold">0%</div>
        <div id="cpu-cores" class="opacity-80 text-sm">-</div>
      </div>
      <div class="glass p-4">
        <div class="text-sm opacity-80 mb-1">Memory</div>
        <div id="mem-pct" class="text-3xl font-extrabold">0%</div>
        <div id="mem-info" class="opacity-80 text-sm">-</div>
      </div>
      <div class="glass p-4">
        <div class="text-sm opacity-80 mb-1">Disk</div>
        <div id="disk-pct" class="text-3xl font-extrabold">0%</div>
        <div id="disk-info" class="opacity-80 text-sm">-</div>
      </div>
      <div class="glass p-4">
        <div class="text-sm opacity-80 mb-1">Network</div>
        <div id="net-sent" class="font-bold">↑ 0 B/s</div>
        <div id="net-recv" class="font-bold">↓ 0 B/s</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="glass p-4">
        <h3 class="font-bold mb-2">CPU (per core)</h3>
        <div class="chart-box"><canvas id="cpuChart"></canvas></div>
      </div>
      <div class="glass p-4">
        <h3 class="font-bold mb-2">Memory (%)</h3>
        <div class="chart-box"><canvas id="memChart"></canvas></div>
      </div>
      <div class="glass p-4">
        <h3 class="font-bold mb-2">Disk (%)</h3>
        <div class="chart-box"><canvas id="diskChart"></canvas></div>
      </div>
      <div class="glass p-4">
        <h3 class="font-bold mb-2">Network (MB/s)</h3>
        <div class="chart-box"><canvas id="netChart"></canvas></div>
      </div>
    </div>

    <!-- Processes -->
    <div class="glass p-4">
      <div class="flex items-center justify-between mb-3 gap-3">
        <h3 class="font-bold">Processes</h3>
        <input id="proc-search" class="px-3 py-2 rounded border border-white/20 bg-white/10 w-64" placeholder="Search…" />
      </div>
      <div style="max-height:420px; overflow:auto">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-black/10">
            <tr>
              <th class="text-left px-3 py-2">PID</th>
              <th class="text-left px-3 py-2">User</th>
              <th class="text-left px-3 py-2">CPU %</th>
              <th class="text-left px-3 py-2">Mem %</th>
              <th class="text-left px-3 py-2">Command</th>
              <th class="text-left px-3 py-2">Action</th>
            </tr>
          </thead>
          <tbody id="proc-body"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* Theme button */
(function(){
  const btn = document.getElementById('theme-toggle');
  const icon = document.getElementById('theme-icon');
  const stored = localStorage.getItem('theme');
  const light = stored==='light';
  document.body.classList.toggle('light', light);
  icon.innerHTML = light
    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>'
    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
  btn.addEventListener('click', ()=>{
    const isLight = document.body.classList.toggle('light');
    localStorage.setItem('theme', isLight ? 'light':'dark');
    icon.innerHTML = isLight
      ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>'
      : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
  });
})();

/* Monitor logic */
const GET_SYSTEM_DATA = './get_system_data';
const $ = (id)=>document.getElementById(id);

let cpuChart, memChart, diskChart, netChart;
let labels = Array(60).fill('');
let memSeries = Array(60).fill(0);
let diskSeries = Array(60).fill(0);
let txSeries = Array(60).fill(0);
let rxSeries = Array(60).fill(0);
let lastNet = {sent:0, recv:0};
let lastTime = 0;

function fmtRate(bps){
  if (!Number.isFinite(bps) || bps < 0) bps = 0;
  if (bps < 1024) return `${bps.toFixed(0)} B/s`;
  if (bps < 1024*1024) return `${(bps/1024).toFixed(2)} KB/s`;
  return `${(bps/1024/1024).toFixed(2)} MB/s`;
}

function makeLineChart(canvasId, label, color, series, max100=true){
  const ctx = document.getElementById(canvasId).getContext('2d');
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{
      label, data:series, borderColor:color, backgroundColor:color+'22',
      borderWidth:2, fill:true, tension:.35, pointRadius:0
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,  // <— key for shrinking
      animation:false,
      interaction:{mode:'index', intersect:false},
      scales:{ y:{ beginAtZero:true, ...(max100?{max:100}:{}) } },
      plugins:{ legend:{ display:true } }
    }
  });
}

function makeCpuChart(n){
  const ctx = document.getElementById('cpuChart').getContext('2d');
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#14b8a6','#6366f1'];
  const datasets = Array.from({length:n}, (_,i)=>({
    label:`Core ${i+1}`,
    data:Array(60).fill(0),
    borderColor:colors[i%colors.length],
    backgroundColor:colors[i%colors.length]+'22',
    borderWidth:2, fill:true, tension:.35, pointRadius:0
  }));
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true,
      maintainAspectRatio:false,  // <— key
      animation:false,
      interaction:{mode:'index', intersect:false},
      scales:{ y:{ beginAtZero:true, max:100 } },
      plugins:{ legend:{ display:true } }
    }
  });
}

function ensureCpuChart(n){
  if (!cpuChart){ cpuChart = makeCpuChart(n); return; }
  if (cpuChart.data.datasets.length !== n){
    cpuChart.destroy(); cpuChart = makeCpuChart(n);
  }
}

function shiftPush(arr, v){ arr.shift(); arr.push(v); }

function renderProcesses(list){
  const body = $('proc-body');
  body.innerHTML = '';
  (list||[]).forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2">${p.pid}</td>
      <td class="px-3 py-2">${p.user}</td>
      <td class="px-3 py-2">${Number(p.cpu||0).toFixed(1)}</td>
      <td class="px-3 py-2">${Number(p.memory||0).toFixed(1)}</td>
      <td class="px-3 py-2">${p.command||''}</td>
      <td class="px-3 py-2">
        <button class="px-3 py-1 rounded bg-red-500/80 hover:bg-red-600 text-white"
                onclick="killProcess(${p.pid})">Kill</button>
      </td>`;
    body.appendChild(tr);
  });
}

async function killProcess(pid){
  if (!confirm(`Kill process ${pid}?`)) return;
  try{
    const r = await fetch(`./kill_process/${pid}`, { method:'POST' });
    const data = await r.json().catch(()=>({}));
    alert(data.message || (r.ok ? 'Killed' : `HTTP ${r.status}`));
  }catch(e){
    alert(`Failed: ${e.message}`);
  }finally{
    try{ update(await fetchOnce()); }catch(_e){}
  }
}
window.killProcess = killProcess;

function update(data){
  const cores = Array.isArray(data.cpu) ? data.cpu.length : 1;
  ensureCpuChart(cores);

  shiftPush(labels, '');

  for (let i=0;i<cores;i++){
    const ds = cpuChart.data.datasets[i].data;
    shiftPush(ds, Number(data.cpu[i]||0));
  }
  const avg = (data.cpu||[]).reduce((a,b)=>a+Number(b||0),0)/(cores||1);
  $('cpu-avg').textContent = `${avg.toFixed(1)}%`;
  $('cpu-cores').textContent = `${cores} cores`;

  const mp = Number(data.memory?.percent || 0);
  shiftPush(memSeries, mp);
  $('mem-pct').textContent = `${mp.toFixed(1)}%`;
  $('mem-info').textContent = `${(data.memory?.used||0).toFixed(1)} GB / ${(data.memory?.total||0).toFixed(1)} GB`;

  const dp = Number(data.disk?.percent || 0);
  shiftPush(diskSeries, dp);
  $('disk-pct').textContent = `${dp.toFixed(1)}%`;
  $('disk-info').textContent = `${(data.disk?.used||0).toFixed(1)} GB / ${(data.disk?.total||0).toFixed(1)} GB`;

  const now = Date.now();
  const dt = lastTime ? Math.max(0.001, (now - lastTime)/1000) : 1;
  lastTime = now;
  let tx=0, rx=0;
  if (typeof data.network?.tx_bps === 'number' || typeof data.network?.rx_bps === 'number') {
    tx = Number(data.network?.tx_bps||0);
    rx = Number(data.network?.rx_bps||0);
  } else if (typeof data.network?.sent === 'number' && typeof data.network?.recv === 'number') {
    if (lastNet.sent===0 && lastNet.recv===0){ lastNet = {sent:data.network.sent, recv:data.network.recv}; }
    tx = (data.network.sent - lastNet.sent)/dt;
    rx = (data.network.recv - lastNet.recv)/dt;
    lastNet = {sent:data.network.sent, recv:data.network.recv};
  }
  shiftPush(txSeries, Math.max(0, tx/(1024*1024)));
  shiftPush(rxSeries, Math.max(0, rx/(1024*1024)));
  $('net-sent').textContent = `↑ ${fmtRate(tx)}`;
  $('net-recv').textContent = `↓ ${fmtRate(rx)}`;

  cpuChart.update('none');
  memChart.data.labels = labels; memChart.data.datasets[0].data = memSeries; memChart.update('none');
  diskChart.data.labels = labels; diskChart.data.datasets[0].data = diskSeries; diskChart.update('none');
  netChart.data.labels  = labels; netChart.update('none');

  renderProcesses(data.processes || []);
}

async function fetchOnce(){
  const r = await fetch(GET_SYSTEM_DATA, { cache:'no-store' });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

(async function init(){
  memChart  = makeLineChart('memChart',  'Memory %', '#3b82f6', memSeries, true);
  diskChart = makeLineChart('diskChart', 'Disk %',   '#10b981', diskSeries, true);
  // Network chart (no max 100)
  const ctxNet = document.getElementById('netChart').getContext('2d');
  netChart  = new Chart(ctxNet, {
    type:'line',
    data:{ labels, datasets:[
      { label:'Sent (MB/s)', data:txSeries, borderColor:'#f59e0b', backgroundColor:'#f59e0b22', borderWidth:2, fill:true, tension:.35, pointRadius:0 },
      { label:'Recv (MB/s)', data:rxSeries, borderColor:'#14b8a6', backgroundColor:'#14b8a622', borderWidth:2, fill:true, tension:.35, pointRadius:0 },
    ]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false, interaction:{mode:'index',intersect:false},
              scales:{ y:{ beginAtZero:true } } }
  });

  // Seed network counters so first point is 0 MB/s and draw first frame
  try{
    const d = await fetchOnce();
    if (typeof d.network?.sent === 'number' && typeof d.network?.recv === 'number'){
      lastNet = {sent:d.network.sent, recv:d.network.recv};
      lastTime = Date.now();
    }
    update(d);
  }catch(e){ /* ignore once */ }

  setInterval(async ()=>{
    try{ update(await fetchOnce()); }catch(_e){}
  }, 3000);

  $('proc-search').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase();
    Array.from($('proc-body').children).forEach(tr=>{
      tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
})();
</script>
</body>
</html>
